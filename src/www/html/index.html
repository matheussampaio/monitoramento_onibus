<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Monitoramento de Ônibus - Home</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- Bootstrap -->
        <link href="css/bootstrap.css" rel="stylesheet" media="screen">

        <script src='http://maps.google.com/maps/api/js?v=3&amp;sensor=false'></script>
        <script src="http://openlayers.org/api/OpenLayers.js"></script>
        <script type="text/javascript">
        var map, layer_onibus;

        var server = "http://192.168.1.244:8080/geoserver/GO/wms";

        var refreshing = false;
        var refreshID;

        function init() {
            var layer_pontos_onibus = new OpenLayers.Layer.WMS(
                "Pontos de Ônibus", server,
                {layers: 'gonibus:pontoonibus', transparent: "true"},
                {singleTile: false, isBaseLayer: false, visibility: true}
                );

            layer_onibus = new OpenLayers.Layer.WMS(
                "Ônibus", server,
                {layers: 'gonibus:lastlocalization', transparent: "true"},
                {singleTile: false, isBaseLayer: false, visibility: true}
                );


            var options = {
                projection: 'EPSG:3857',
                center: new OpenLayers.LonLat(-3996296.2385206,-807660.81172368),
                numZoomLevels: 20,
                zoom: 15
            }

            map = new OpenLayers.Map('map_id', options);

            layer_googleStr = new OpenLayers.Layer.Google("Google Streets",{numZoomLevels: 20});

            map.addLayers([layer_googleStr, layer_pontos_onibus, layer_onibus]);

            <% for (var i=0; i < result.length; i++) { %>
                var nomeRota = <%= result[i].nome %>;
                map.addLayer(new OpenLayers.Layer.WMS("Rota: " + nomeRota, server, {layers: 'gonibus:rota' + nomeRota + 'view', transparent: "true"}, {singleTile: false, isBaseLayer: false, visibility: true}));
            <% } %>

            map.addControl(new OpenLayers.Control.LayerSwitcher());

            map.setCenter(new OpenLayers.LonLat(-3995296.2385206,-806260.81172368), 15);
        }

        function refresh() {
            map.getLayersByName('Ônibus')[0].redraw(true);
        }

        function toggleRefresh() {
            refreshing = !refreshing;

            if (!refreshing) {
                clearInterval(refreshID);
            } else {
                refreshID = window.setInterval( refresh, 5000);
            }
        }

        </script>
    </head>

    <body style="margin-top: 40px">
        <script src="http://code.jquery.com/jquery.js"></script>
        <script src="js/bootstrap.js"></script>

        <div class="navbar navbar-inverse navbar-fixed-top">
          <div class="navbar-inner">
            <a class="brand" href="./home">Monitoramento de Ônibus</a>
            <div class="container">
              <ul class="nav" >
                <li class="active"><a href="./home">Home</a></li>
                <li><a href="./horarios">Horários</a></li>
                <li><a href="./admin">Administração</a></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="row-fluid">
            <div id="map_id" class="span12" style="width: 100%; height: 900px">
                <script>
                    init();
                    toggleRefresh();
                </script>
            </div>
        </div>
    </body>
</html>